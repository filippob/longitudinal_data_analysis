---
title: "surveillance"
output: html_document
date: "2023-06-29"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
install.packages("surveillance")
library(surveillance)
library("Matrix")

# load data

influmen<-data("influMen")

View(influmen)
# convert to sts class and print basic information about the time series
print(fluMen <- disProg2sts(influMen))

meningo <- fluMen[, "meningococcus"]

dim(meningo)

meningo

plot(fluMen, type = observed ~ time | unit, # type of plot (default)
     same.scale = FALSE,
     col = "grey")

# read in observed number of cases

flu.counts <- as.matrix(read.table(system.file("extdata/counts_flu_BYBW.txt",
                                               package = "surveillance"),
                                   check.names = FALSE))
# read in 0/1 adjacency matrix (1 if regions share a common border)
nhood <- as.matrix(read.table(system.file("extdata/neighbourhood_BYBW.txt",
                                          package = "surveillance"),
                              check.names = FALSE))


print(image(Matrix(nhood)))

data("fluBYBW")

plot(fluBYBW[year(fluBYBW) == 2001, ], # select year 2001
     type = observed ~ unit,           # total counts by region
     population = fluBYBW@map$X31_12_01 / 100000, # per 100000 inhabitants
     colorkey = list(title = "Incidence [per 100'000 inhabitants]"))

data("measlesDE")

measles2w <- aggregate(measlesDE, nfreq = 26)
plot(measles2w, type = observed ~ time,  # aggregate counts over all units
     main = "Bi-weekly number of measles cases in Germany")

# specify a formula object for the endemic component
( f_S1 <- addSeason2formula(f = ~ 1, S = 1, period = 52) )
# fit the Poisson model
result0 <- hhh4(meningo, control = list(end = list(f = f_S1), family = "Poisson"))
summary(result0)
result1 <- update(result0, family = "NegBin1")

AIC(result0, result1)
# fit an autoregressive model
result2 <- update(result1, ar = list(f = ~ 1))

plot(result2)

coef(result2, se = TRUE, amplitudeShift = TRUE, idx2Exp = TRUE)

neighbourhood(fluMen)["meningococcus","influenza"] <- 0

neighbourhood(fluMen)
# create formula for endemic component

f.end <- addSeason2formula(f = ~ -1 + fe(1, unitSpecific = TRUE),
                           S = c(3, 1),  
                             period = 52)
m <- list(ar = list(f = ~ -1 + fe(1, unitSpecific = TRUE)),
          ne = list(f = ~ 1, 
                    weights = neighbourhood(fluMen)),
          end = list(f = f.end),
          family = "NegBinM") 

result <- hhh4(fluMen, control = m)

summary(result, idx2Exp=1:3)

plot(result, units = NULL, pch = 20, legend = 2, legend.args = list(
  legend = c("influenza-driven", "autoregressive", "endemic")))

```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
